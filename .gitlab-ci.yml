variables:
  MIRROR_REPO: git@github.com:thm-projects/arsnova-flashcards.git
  NODE_ENV: production
  BUILD_DIR: build
  BUNDLE_DIR: "$BUILD_DIR/bundle"

stages:
#  - test
  - build
  - review
#  - deploy

build:
  stage: build
  tags:
    - meteor
  image: local-nodejs-meteor:1.6
  dependencies: []
  script:
    - test -d package-metadata && rm -rf /opt/meteor/package-metadata && mv package-metadata /opt/meteor/
    - npm install
    - meteor build --allow-superuser --server-only --directory "$BUILD_DIR"
    - mv /opt/meteor/package-metadata "$CI_PROJECT_DIR/"
  cache:
    paths:
      - package-metadata
      - .meteor/local
  artifacts:
    paths:
      - "$BUNDLE_DIR"

review:
  stage: review
  script:
    - METEOR_PORT=$(echo $CI_BUILD_REF_NAME | head -c3)0
    - NGINX_PORT=1`echo $METEOR_PORT`
    - METEOR_HOME=/srv/review-apps/$METEOR_PORT
    - mkdir -p $METEOR_HOME/logs
    - mkdir -p $METEOR_HOME/app
    - cp /srv/review-apps/appctl.sh $METEOR_HOME
    - cp /srv/review-apps/meteor-settings.json $METEOR_HOME
    - cp /srv/review-apps/mongo-setup.js $METEOR_HOME
    - cp /srv/review-apps/mongo-restore.sh $METEOR_HOME
    - cp /srv/review-apps/nginx-vhost /etc/nginx/sites-available/meteor-"$NGINX_PORT"
    - sed -i "s/<branch-port>/$METEOR_PORT/g" "$METEOR_HOME"/appctl.sh
    - sed -i "s/<branch-port>/$METEOR_PORT/g" "$METEOR_HOME"/meteor-settings.json
    - sed -i "s/<branch-port>/$METEOR_PORT/g" "$METEOR_HOME"/mongo-setup.js
    - sed -i "s/<branch-port>/$METEOR_PORT/g" "$METEOR_HOME"/mongo-restore.sh
    - rsync -aqv --delete "$BUNDLE_DIR/"* $METEOR_HOME/app
    - cd $METEOR_HOME/app/programs/server
    - npm install
    - cd $METEOR_HOME
    - mongo < mongo-setup.js
    - ./mongo-restore.sh
    - ./appctl.sh start
    - sed -i "s/<branch-nginx-port>/$NGINX_PORT/g" /etc/nginx/sites-available/meteor-"$NGINX_PORT"
    - sed -i "s/<branch-port>/$METEOR_PORT/g" /etc/nginx/sites-available/meteor-"$NGINX_PORT"
    - ln -s /etc/nginx/sites-available/meteor-"$NGINX_PORT" /etc/nginx/sites-enabled/meteor-"$NGINX_PORT"
    - sudo systemctl reload nginx.service
  environment:
    name: review/$CI_BUILD_REF_NAME
    url: http://review.arsnova.cards:$NGINX_PORT
    on_stop: stop_review
  only:
    - branches
  except:
    - master
  tags:
    - cards-review

stop_review:
  stage: review
  script:
    - echo $METEOR_PORT
#    - rm -rf "$BUILD_DIR" /srv/nginx/pages/$CI_BUILD_REF_SLUG
  variables:
    GIT_STRATEGY: none
  when: manual
  environment:
    name: review/$CI_BUILD_REF_NAME
    action: stop
  tags:
    - cards-review

