variables:
  MIRROR_REPO: git@github.com:thm-projects/arsnova-flashcards.git
  NODE_ENV: production
  BUILD_DIR: build
  BUNDLE_DIR: "$BUILD_DIR/bundle"

stages:
#  - test
#  - build
  - review
#  - deploy

#build:
#  stage: build
#  only:
#    - master
#    - staging
#    - /^v[0-9]+/
#  tags:
#    - meteor
#  image: local-nodejs-meteor:1.6
#  dependencies: []
#  script:
#    - test -d package-metadata && rm -rf /opt/meteor/package-metadata && mv package-metadata /opt/meteor/
#    - npm install
#    - meteor build --allow-superuser --server-only --directory "$BUILD_DIR"
#    - mv /opt/meteor/package-metadata "$CI_PROJECT_DIR/"
#  cache:
#    paths:
#      - package-metadata
#      - .meteor/local
#  artifacts:
#    paths:
#      - "$BUNDLE_DIR"

review:
  stage: review
  script:
    - METEOR_PORT=$(echo $CI_BUILD_REF_NAME | head -c3)0
    - echo $METEOR_PORT
#    - rsync -av --delete "$BUILD_DIR" /srv/nginx/pages/$CI_BUILD_REF_SLUG
  environment:
    name: review/$CI_BUILD_REF_NAME
    url: http://review.arsnova.cards:$METEOR_PORT
    on_stop: stop_review
  only:
    - branches
  except:
    - master
  tags:
    - cards-review

stop_review:
  stage: review
  script:
    - echo $METEOR_PORT
#    - rm -rf "$BUILD_DIR" /srv/nginx/pages/$CI_BUILD_REF_SLUG
  variables:
    GIT_STRATEGY: none
  when: manual
  environment:
    name: review/$CI_BUILD_REF_NAME
    action: stop
  tags:
    - cards-review

