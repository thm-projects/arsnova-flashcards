variables:
  MIRROR_REPO: git@github.com:thm-projects/arsnova-flashcards.git
  NODE_ENV: production
  BUILD_DIR: build
  BUNDLE_DIR: "$BUILD_DIR/bundle"

stages:
  - test
  - build
  - review
  - deploy

chimp:
  stage: test
  only:
    - staging
    - /^v[0-9]+/
  tags:
    - nodejs
  allow_failure: true
  services:
    - mongo
  dependencies: []
  variables:
    PORT: "3000"
    ROOT_URL: "http://localhost:$PORT"
    MONGO_HOST: mongo
    MONGO_PORT: "27017"
    MONGO_DB: meteor-test
    MONGO_URL: "mongodb://$MONGO_HOST:$MONGO_PORT/$MONGO_DB"
  script:
    - export METEOR_SETTINGS="$(cat settings_test.json)"
    - mongo --quiet --eval "version();" --host "$MONGO_HOST"
    - cd "$BUNDLE_DIR/programs/server" && npm install
    - cd -
    - node "$BUNDLE_DIR/main.js" &
    - sleep 15
    - ./tests/runTests.sh

jshint:
  stage: test
  tags:
    - nodejs
  allow_failure: true
  dependencies: []
  script:
    - echo "{}" > package.json
    - npm install jshint@^2.9.0
    - node_modules/jshint/bin/jshint --config .jshintrc ./client/ ./server/ ./imports/ ./i18n ./tests

jscs:
  stage: test
  tags:
    - nodejs
  dependencies: []
  script:
    - npm install jscs
    - node_modules/jscs/bin/jscs --config .jscsrc ./{client,imports,i18n,server,tests}/

sonar:
  stage: test
  only:
    - master
    - staging
  tags:
    - gradle
  allow_failure: true
  dependencies: []
  script:
    - gradle sonarqube

jsdoc:
  stage: build
  only:
    - staging
  tags:
    - nodejs
  dependencies: []
  script:
    - npm install
    - jsdoc -c documentation/conf.json -t ./node_modules/ink-docstrap/template -d build/jsdoc -r
  artifacts:
    paths:
      - "$BUILD_DIR/jsdoc/"

build:
  stage: build
  tags:
    - meteor
  image: local-nodejs-meteor:1.6
  dependencies: []
  script:
    - test -d package-metadata && rm -rf /opt/meteor/package-metadata && mv package-metadata /opt/meteor/
    - npm install
    - meteor build --allow-superuser --server-only --directory "$BUILD_DIR"
    - mv /opt/meteor/package-metadata "$CI_PROJECT_DIR/"
  cache:
    paths:
      - package-metadata
      - .meteor/local
  artifacts:
    paths:
      - "$BUNDLE_DIR"

review:
  stage: review
  script:
    - METEOR_PORT=$(echo $CI_BUILD_REF_NAME | head -c3)0
    - NGINX_PORT=1`echo $METEOR_PORT`
    - METEOR_HOME=/srv/review-apps/$METEOR_PORT
    - mkdir -p $METEOR_HOME/logs
    - mkdir -p $METEOR_HOME/app
    - rm -f /etc/nginx/sites-available/meteor-"$NGINX_PORT"
    - rm -f /etc/nginx/sites-enabled/meteor-"$NGINX_PORT"
    - cp /srv/review-apps/appctl.sh $METEOR_HOME
    - cp /srv/review-apps/meteor-settings.json $METEOR_HOME
    - cp /srv/review-apps/mongo-setup.js $METEOR_HOME
    - cp /srv/review-apps/mongo-restore.sh $METEOR_HOME
    - cp /srv/review-apps/nginx-vhost /etc/nginx/sites-available/meteor-"$NGINX_PORT"
    - sed -i "s/<branch-port>/$METEOR_PORT/g" "$METEOR_HOME"/appctl.sh
    - sed -i "s/<branch-port>/$METEOR_PORT/g" "$METEOR_HOME"/meteor-settings.json
    - sed -i "s/<branch-nginx-port>/$NGINX_PORT/g" "$METEOR_HOME"/meteor-settings.json
    - sed -i "s/<branch-port>/$METEOR_PORT/g" "$METEOR_HOME"/mongo-setup.js
    - sed -i "s/<branch-port>/$METEOR_PORT/g" "$METEOR_HOME"/mongo-restore.sh
    - rsync -aqv --delete "$BUNDLE_DIR/"* $METEOR_HOME/app
    - cd $METEOR_HOME
    - ./appctl.sh stop
    - cd $METEOR_HOME/app/programs/server
    - npm install
    - cd $METEOR_HOME
    - mongo < mongo-setup.js
    - ./mongo-restore.sh
    - ./appctl.sh start
    - sleep 45s
    - sed -i "s/<branch-nginx-port>/$NGINX_PORT/g" /etc/nginx/sites-available/meteor-"$NGINX_PORT"
    - sed -i "s/<branch-port>/$METEOR_PORT/g" /etc/nginx/sites-available/meteor-"$NGINX_PORT"
    - sed -i "s/<ci-ref>/$CI_BUILD_REF_NAME/g" /etc/nginx/sites-available/meteor-"$NGINX_PORT"
    - ln -s /etc/nginx/sites-available/meteor-"$NGINX_PORT" /etc/nginx/sites-enabled/meteor-"$NGINX_PORT"
    - sudo systemctl reload nginx.service
  environment:
    name: review/$CI_BUILD_REF_NAME
    url: http://$CI_BUILD_REF_NAME.review.arsnova.cards/
    on_stop: stop_review
  only:
    - /^[[:digit:]]{3}/
  except:
    - staging
    - master
  tags:
    - cards-review

stop_review:
  stage: review
  script:
    - METEOR_PORT=$(echo $CI_BUILD_REF_NAME | head -c3)0
    - METEOR_HOME=/srv/review-apps/$METEOR_PORT
    - cd $METEOR_HOME
    - ./appctl.sh stop
    - cd /srv/review-apps
    - rm -rf $METEOR_HOME
  variables:
    GIT_STRATEGY: none
  when: manual
  environment:
    name: review/$CI_BUILD_REF_NAME
    action: stop
  only:
    - /^[[:digit:]]{3}/
  except:
    - staging
    - master
  tags:
    - cards-review

sync_mirror:
  stage: deploy
  tags:
    - git
  when: always
  allow_failure: true
  dependencies: []
  script:
    - eval $(ssh-agent -s)
    - mkdir ~/.ssh && echo "$SYNC_SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - ssh-add <(echo "$SYNC_SSH_PRIVATE_KEY")
    - git clone --bare "$CI_REPOSITORY_URL" mirror.git
    - cd mirror.git
    - git push --mirror "$MIRROR_REPO"
  environment: GitHub

