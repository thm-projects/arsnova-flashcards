const plantumlEncoder=require("plantuml-encoder"),fs=require("fs"),fromHash=function(t){const e={},n=t.$$smap;for(let t in n)e[t]=n[t];return e};function UnsupportedFormat(t){this.name="UnsupportedFormat",this.message=t,this.stack=(new Error).stack}function UndefinedPlantumlServer(t){this.name="UndefinedPlantumlServer",this.message=t,this.stack=(new Error).stack}function createImageSrc(t,e,n,r,a){const o=t.getAttribute("plantuml-server-url"),l=t.isAttribute("plantuml-fetch-diagram");let s=`${o}/${r}/${plantumlEncoder.encode(e)}`;return l&&(s=require("./fetch").save(s,t,n,r,a)),s}function processPlantuml(t,e,n,r,a,o){const l=e.getDocument(),s=n.subs;s&&(a=e.$apply_subs(a,e.$resolve_subs(s),!0));const i=l.getAttribute("plantuml-config-file");if(i&&fs.existsSync(i)){let t=fs.readFileSync(i);t&&(a=t+"\n"+a)}/^@start([a-z]+)\n[\s\S]*\n@end\1$/.test(a)||("plantuml"===r?a="@startuml\n"+a+"\n@enduml":"ditaa"===r?a="@startditaa\n"+a+"\n@endditaa":"graphviz"===r&&(a="@startdot\n"+a+"\n@enddot"));const c=l.getAttribute("plantuml-server-url"),u=n.role,m=n.id,p=n.title;if(c){const r=n.target,s=n.format||"png";if("png"===s||"svg"===s){const n={role:u?`${u} plantuml`:"plantuml",target:createImageSrc(l,a,r,s,o.vfs),alt:r||"diagram",title:p};return m&&(n.id=m),t.createImageBlock(e,n)}throw new UnsupportedFormat(`Format '${s}' is unsupported. Only 'png' and 'svg' are supported by the PlantUML server`)}throw new UndefinedPlantumlServer("PlantUML server URL is undefined. Please use the :plantuml-server-url: attribute to configure it.")}function plantumlBlock(t){return function(){this.onContext(["listing","literal"]),this.positionalAttributes(["target","format"]),this.process((e,n,r)=>{"object"==typeof r&&"$$smap"in r&&(r=fromHash(r));const a=this.name.toString(),o=r.role;let l=n.getString();try{return processPlantuml(this,e,r,a,l,t)}catch(t){if("UnsupportedFormat"===t.name||"UndefinedPlantumlServer"===t.name)return console.warn(`Skipping ${a} block. ${t.message}`),r.role=o?`${o} plantuml-error`:"plantuml-error",this.createBlock(e,r["cloaked-context"],l,r);throw t}})}}function plantumlBlockMacro(t,e){return function(){this.named(t),this.process((n,r,a)=>{"object"==typeof a&&"$$smap"in a&&(a=fromHash(a));let o=e.vfs;void 0!==o&&"function"==typeof o.read||(o=require("./node-fs"));const l=a.role,s=t;r=n.$apply_subs(r);let i=o.read(r);try{return processPlantuml(this,n,a,s,i,e)}catch(t){if("UnsupportedFormat"===t.name||"UndefinedPlantumlServer"===t.name)return console.warn(`Skipping ${s} block macro. ${t.message}`),a.role=l?`${l} plantuml-error`:"plantuml-error",this.createBlock(n,"paragraph",`${t.message} - ${s}::${r}[]`,a);throw t}})}}UnsupportedFormat.prototype=new Error,UndefinedPlantumlServer.prototype=new Error;const antoraAdapter=(t,e)=>({add:n=>{const{component:r,version:a,module:o}=t.src;e.getById({component:r,version:a,module:o,family:"image",relative:n.basename})||e.addFile({contents:n.contents,src:{component:r,version:a,module:o,family:"image",mediaType:n.mediaType,basename:n.basename,relative:n.basename}})}});module.exports.register=function(t,e={}){return void 0!==e.contentCatalog&&void 0!==e.contentCatalog.addFile&&"function"==typeof e.contentCatalog.addFile&&void 0!==e.file&&(e.vfs=antoraAdapter(e.file,e.contentCatalog)),"function"==typeof t.register?t.register(function(){this.block("plantuml",plantumlBlock(e)),this.block("ditaa",plantumlBlock(e)),this.block("graphviz",plantumlBlock(e)),this.blockMacro(plantumlBlockMacro("plantuml",e)),this.blockMacro(plantumlBlockMacro("ditaa",e)),this.blockMacro(plantumlBlockMacro("graphviz",e))}):"function"==typeof t.block&&(t.block("plantuml",plantumlBlock(e)),t.block("ditaa",plantumlBlock(e)),t.block("graphviz",plantumlBlock(e)),t.blockMacro(plantumlBlockMacro("plantuml",e)),t.blockMacro(plantumlBlockMacro("ditaa",e)),t.blockMacro(plantumlBlockMacro("graphviz",e))),t};